#!/bin/sh
# Homelab Configuration File
# Source this file in other scripts with: . ./0-Homelab.conf
# POSIX compliant

# ===============================================================================
# PROXMOX CONFIGURATION
# ===============================================================================
PROXMOX_SOURCENODE="pve"
PROXMOX_HOST="192.168.25.11"
PROXMOX_PORT="8006"
PROXMOX_CLUSTER_NAME="proxmox-cluster"

# Load secrets from separate file (not tracked by git)
if [ -f "./0-Homelab.secrets" ]; then
    . ./0-Homelab.secrets
else
    printf "\033[0;31m[ERROR]\033[0m Secrets file 0-Homelab.secrets not found!\n"
    printf "Please copy 0-Homelab.secrets.template to 0-Homelab.secrets and fill in your values.\n"
    exit 1
fi

# Auto-generated values (do not modify)
PROXMOX_TOKEN_NAME="clusterapi"
PROXMOX_TOKEN="${PROXMOX_USER}@pve!${PROXMOX_TOKEN_NAME}"

# ===============================================================================
# PROXMOX VM TEMPLATE SETTINGS
# ===============================================================================
TEMPLATE_VMID="9000"
TALOS_ISO_PATH="Data:iso/nocloud-amd64.iso"

# VM Template configuration
TEMPLATE_NAME="talos-template"
TEMPLATE_TAG="cluster-api-talos"
TEMPLATE_MEMORY="2048"
TEMPLATE_CPU="x86-64-v3" # more info : https://docs.siderolabs.com/talos/v1.9/platform-specific-installations/virtualized-platforms/proxmox
TEMPLATE_CPU_FLAGS="+aes;+md-clear;+pcid;+spec-ctrl;+ssbd" 
TEMPLATE_CORES="2"
TEMPLATE_SOCKETS="1"
TEMPLATE_DISK="scsi0"
TEMPLATE_DISK_SIZE="20"
TEMPLATE_STORAGE="local-lvm"
TEMPLATE_BRIDGE="vmbr0"
TEMPLATE_ONBOOT="1" # Start VM on Proxmox host boot 

# ===============================================================================
# KUBERNETES CLUSTER SETTINGS
# ===============================================================================

# Management cluster settings
MANAGEMENT_CLUSTER_NAME="management"

# Cluster API provider URLs (using latest releases)
TALOS_BOOTSTRAP_PROVIDER_URL="https://github.com/siderolabs/cluster-api-bootstrap-provider-talos/releases/latest/download/bootstrap-components.yaml"
TALOS_CONTROL_PLANE_PROVIDER_URL="https://github.com/siderolabs/cluster-api-control-plane-provider-talos/releases/latest/download/control-plane-components.yaml"
PROXMOX_INFRASTRUCTURE_PROVIDER_URL="https://github.com/ionos-cloud/cluster-api-provider-proxmox/releases/latest/download/infrastructure-components.yaml"

# Workload cluster settings
CLUSTER_NAME="talos-k8s"
CLUSTER_NAMESPACE="default"
KUBERNETES_VERSION="v1.31.0"
CONTROL_PLANE_REPLICAS="1"
WORKER_REPLICAS="2"

# Network CIDR blocks
POD_CIDR="10.244.0.0/16"
SERVICE_CIDR="10.96.0.0/12"

# ===============================================================================
# NETWORK CONFIGURATION
# ===============================================================================

CONTROL_PLANE_ENDPOINT_IP="192.168.25.101"
IP_POOL_START="192.168.25.102"
IP_POOL_END="192.168.25.105"
IP_POOL_NAME="talos-pool"
GATEWAY="192.168.25.1"
IP_PREFIX="24"
DNS_SERVERS="192.168.25.15"

# ===============================================================================
# FILE PATHS
# ===============================================================================

# Configuration and output directories
CLUSTERCTL_CONFIG_PATH="./clusterctl-configs"
CLUSTERCTL_CONFIG_FILE="clusterctl.yaml"
KUBECTL_CONFIG_PATH="./kubectl-configs"
KUBECTL_CONFIG_FILE="kubectl.yaml"
